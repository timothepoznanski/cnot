name: Smart PR Creation with Fast-forward

on:
  push:
    branches: [ dev ]

jobs:
  test-and-create-pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT_TOKEN }}
    
    - name: Test Docker build
      run: |
        echo "Testing Docker build..."
        docker build -t cnot-test .
        echo "Docker build successful"
    
    - name: Test Docker Compose
      run: |
        echo "Testing Docker Compose configuration..."
        docker compose config
        echo "Docker Compose configuration valid"
    
    - name: PHP Syntax Check
      run: |
        echo "Checking PHP syntax..."
        docker run --rm -v $(pwd)/src:/app php:8.1-cli find /app -name "*.php" -exec php -l {} \;
        echo "PHP syntax check passed"
    
    - name: Sync and check for conflicts
      run: |
        echo "Checking if dev can be fast-forwarded into main..."
        git fetch origin main
        
        # Check if dev is ahead of main (no conflicts)
        if git merge-base --is-ancestor origin/main HEAD; then
          echo "âœ… Dev is ahead of main - no conflicts expected"
        else
          echo "âš ï¸ Dev has diverged from main - conflicts possible"
          # Try to auto-resolve by rebasing
          git rebase origin/main || {
            echo "âŒ Cannot auto-resolve conflicts"
            exit 1
          }
          git push --force-with-lease origin dev
        fi
    
    - name: Create Pull Request with fast-forward strategy
      run: |
        echo "Checking for existing PRs..."
        existing_pr=$(gh pr list --head dev --base main --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
        
        if [ -z "$existing_pr" ] || [ "$existing_pr" = "null" ]; then
          echo "Creating PR with fast-forward merge strategy..."
          gh pr create \
            --base main \
            --head dev \
            --title "Deploy to production (Fast-forward merge)" \
            --body "ðŸš€ Automatic deployment PR from dev branch. This PR uses fast-forward merge to avoid conflicts. Merge strategy: Fast-forward only. Conflicts: None expected âœ…"
          echo "Pull Request created successfully!"
        else
          echo "PR already exists (#$existing_pr)"
        fi
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
