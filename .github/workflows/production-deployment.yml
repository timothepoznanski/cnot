name: Production Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to production server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USERNAME }}
        key: ${{ secrets.PROD_SSH_KEY }}
        passphrase: ${{ secrets.PROD_SSH_PASSPHRASE }}
        port: ${{ secrets.PROD_PORT }}
        script: |
          set -e
          echo "ğŸ”„ Starting production deployment..."
          
          cd ${{ secrets.PROD_PROJECT_PATH }}
          echo "ğŸ“ Working directory: $(pwd)"
          
          echo "ï¿½ Configuring Git for HTTPS authentication..."
          git remote set-url origin https://${{ secrets.GITHUB_TOKEN }}@github.com/timothepoznanski/cnot.git
          
          echo "ï¿½ğŸ”„ Switching to main branch..."
          git checkout main
          
          echo "ğŸ“¥ Pulling latest changes from main..."
          if ! git pull origin main; then
            echo "âŒ Git pull failed! Deployment aborted."
            echo "This could be due to:"
            echo "  - Network connectivity issues"
            echo "  - Authentication problems"
            echo "  - Local changes conflicting with remote"
            echo "  - Repository access permissions"
            echo "Current remote URL: $(git remote get-url origin)"
            exit 1
          fi
          echo "âœ… Git pull successful, proceeding with deployment..."
          
          echo "ğŸ”¨ Building Docker images (no cache)..."
          docker compose -f docker-compose.yml -f docker-compose-reverse-proxy.yml build --no-cache
          
          echo "ğŸš€ Recreating and starting containers..."
          docker compose -f docker-compose.yml -f docker-compose-reverse-proxy.yml up -d --force-recreate
          
          echo "â†©ï¸  Switching back to dev branch..."
          git checkout dev
          
          echo "ğŸ‰ Production deployment completed successfully!"
    
    - name: Notify deployment success
      if: success()
      run: echo "ğŸ‰ Production deployment successful!"
    
    - name: Notify deployment failure
      if: failure()
      run: echo "âŒ Production deployment failed"
